# Customized plugin descriptions guide

VRay plugin definitions are generated by the **plugininfo** tool and stored in the ***vray_blender\plugins_desc*** folder as JSON files. The information in the plugin description file is not sufficient to know how to export the plugin to V-Rayor show it in the UI. Various customization options are possible using custom plugin description files which can be used to alter or extend the information in the main plugin description.

A custom plugin description file is a file placed in the same directory as the main plugin json file, with the same name and the extension changed from "json" to "custom.json”. At Blender startup, the contents of the "custom.json” file is merged into the contents of the main json file.

The general layout of a custom plugin description file is as follows:

```json
{
   "ID" : "Plugin Type",
   "Name" : "Plugin Label",
   "Desciption" : "Some plugin",
   "Type" : "The category of the plugin",	
   "Parameters" : [],
   "Widget" : {
      "widgets": []
   },
   "Node": {
      "input_sockets": [],
      "output_sockets": [],
      "widgets": [],
	  "internal_links": {}
   },
   "Options": {}
}

```

Custom description files augment the structure as the main description files. They allow overriding all properties with the exception of the plugin "**ID**". New parameters may be appended to the "**Parameters**" list.

# SECTIONS

## >> Parameters

Each parameter describes a single plugin property. The attributes of the parameter define the way the property is exported and to a certain extent how the property is shown in the UI ( the rest of the UI-related settings are defined in the 'Widget' section ).

While most of the parameters correspond to a plugin property, some of them (defined in a .custom.json file) are only needed for auxiliary data storage associated with the plugin.

`attr`:  (string) The name of the plugin property.

`default`: The default value for the plugin property. The format depends on the type of the property.

`type`: (string) The V-Ray type of the parameter, e.g. "BOOL", "INT", "TEXTURE" etc.

`subtype`: (string) One of the [property subtypes](https://docs.blender.org/api/current/bpy_types_enum_items/property_subtype_items.html#rna-enum-property-subtype-items) defined by Blender.

`desc`: (string) A description of the property which will be shown in the UI.

`precision`: (int) Precision of float values in digits after the decimal point

`ui`: (dict) This section contains additional UI-related data, e.g. min/max constraints for numeric properties etc.

* min  
* max  
* soft_min  
* sof_max  
* spi_step  
* displa_name  
* file_extensions - A list of file extensions ['ext1', 'ext2'], Applicable to properties of type STRING with file path semantics. When defined, the property will be automatically assigned the "FILE_PATH" subtype.

`update`: (string) The name of a custom [**callback function**](#callbacks) for the property with the signature 
	
	onUpdate( updateSource, context: bpy.types.Context, attrName: str ) -> None
where *updateSource* is either a vray property group or a node socket depending on the invocation context. 

`poll`: (string) The name of a custom poll function for the property with the signature

	`pollFunction(self, object) -> bool

where *self* is either a vray property group or a node socket depending on the invocation context.The function must be defined in the plugin module.

`set`:	(string) The name of a custom 'set' function for the property with the signature 

	`onPropertySet( propGroup, attrName: str, value: Any ) -> None`

where *propGroup* is the vray property group to which the property belongs.

`get`:	(string) The name of a custom 'get' function for the property with the signature 

	`onPropertyGet( propGroup, attrName: str ) -> Any`

where *propGroup* is the vray property group to which the property belongs.


### options
Each parameter may have an `options` dictionary with any of the following:

`visible`: (bool) A flag indicating whether the property will be shown in the UI if a 'widget' section is not available for the plugin. 

`animatable`: (bool) True to show animation interface for this parameter in Blender's UI

`derived`: (bool) When true, marks the parameter as a synthetic one, i.e. one which is not a VRay plugin parameter. Such parameters are used to store state which is not directly exported, e.g. the enabled state of a block of properties. 

`value_conv_factor`:(int | float) When present, the value of the property will be multiplied by it when shown in the UI and divided by it when stored in the plugin property. 

`shadowed`: (bool) When true, a shadow property with a well-known name is registered. This property is not shown in the UI and can be used by the implementation as a cache for the value of the normal property, e.g. when we need to compare the value before and after a change.



## >> Widget

The Widget section is a description of the Blender UI that will be created for the property pages of the plugin.

### **widgets**

A list of [widget descriptions](#widget-description). This is the default widgets list which will be shown automatically by the drawing logic.

### **arbitrary_widgets_list_name**

Some plugins may require custom draw logic to draw an arbitrary list of widgets using the draw\_utils module. Here we can have lists of widgets under arbitrary names which can then be passed to the drawing code.



## >> Node

The Node section is a description of the nodes generated from plugin descriptions.

### **input_sockets**

A list of the visible sockets on the node. Sockets are created for all non-excluded properties of the plugin, but only some of them are actually shown.

`name`:  	(string) The name of the property in the plugin’s json description file to bind to (the ID field)  
`type`:    	(string) This allows to specify a different data type for the socket  
`label`:  	(string or [condition](#conditions)) Override the label set in Parameters section  
`desc`:    	(string) Override the description set in Parameters section

### **output_sockets**

A list of output sockets on the node.

`name`:  	(string) The name of the property in the plugin’s json description file to bind to (the ID field)  
`label`:   	(string or [condition](#conditions)) Override the label set in Parameters section  
`desc`:    	(string) Override the description set in Parameters section  
`visible`:  (bool) Set the initial visibility of the socket. This may be set to *false* to create sockets which are shown on demand.

 	  
NOTE: The *input_sockets* section lists the **visible** sockets of the node. Sockets are created for all properties of the plugin but only some of them are actually shown on the node.

### **widgets**

The non-socket [widgets](#widget-description) to show on the node

### **internal_links**
A dictionary of lists defining the allowed paths from output to input sockets when the node is muted. If this property is not defined, no internal links are allowed.

```json
"internal_links": {
	"output_socket_name_1": ["input_socket_name_1", "input_socket_name_1"],
	"output_socket_name_2": ["*"]

```
`output_socket_name`: The .name property of a socket or "*" to indicate that all output sockets will be connected to the same set of input sockets.

`input_socket_name`: The .name property of an input socket. 
*  If the last symbol is '*' (e.g. 'Color *'), it is treated as a wildcard. This is useful for dynamically created numbered sockets ('Color 1', 'Color 2' etc)
* If the list is just ["*"], the output is connected to ALL input sockets 



## >> Options

Options applicable to the whole plugin.

`excluded_parameters`:	A list of plugin parameters that should not be exported and should not be shown to the user. These may include deprecated parameters and parameters the user should not change (when e.g. the default value is always the best choice).

`animatable`: (bool, default: true) For some plugins, e.g. most Settings, animating values does not make sense. Set to 'false' to disallow animating on all parameters that are not explicitly defined as animatable in their parameter description. 



# COMMON DEFINITIONS


### **Widget description** {#widget-description}

A widget serves as a visual container for plugin properties and other widgets. Both types are declared in the "attrs" list of a parent widget. The presence of a 'layout' field in an attribute indicates that the attribute is a child widget vs a simple value.

Widget descriptions support the following attributes:

`layout`:  (string) Required. Determines the visual layout of widget's children. See [Layouts](#layouts) for a list of possible values.  
`name`:    (string) For 'property' widgets, this is the name of the attribute to show. For layout widgets, this is a unique name that may be used for identifying widgets.  **Required** for ROLLOUT layouts.   
`attrs`:   (list of property and widget descriptions) Required. A list of widget's children. See [Property descriptions](#property-descriptions).  
`label`:   (string) A text to show before all child items.    
`align`:   (bool) Set to true to make children align without additional spacing between them.  
`active`:  (bool or [condition](#conditions)) If the condition evaluates to false, the widget is visualized as disabled.    
`visible`: (bool or [condition](#conditions)) If the condition evaluates to false, the widget is hidden.    
`custom_draw`: (string) The name of a [**callback function**](#callbacks) to use for drawing the widget. The signature of the function is:    

		def widgetDrawAttr(bpy.types.Context, layout: bpy.types.Layout, propGroup, widgetAttribute: dict)


A common widget description may look like this:

   ```json
	// "widgets" : [
		{
			"layout": "COLUMN",
			"label": "Shadow options",
			"attrs": [
				{
					"name": "use_shadows",
					"label": "Shadows enabled"
				},
				{
					"layout": "BOX",
					"label": "Shadow settings",
					"attrs": [
						{
							"name": "color",
						}
					]
				}
			]
		}
	// ]

   ```

### **Layouts** {#layouts}

* **COLUMN**

  Attributes are laid out in a column.

* **ROW**  
  Attributes are  placed side-by-side on the same row.

* **BOX**  
  The same as COLUMN, but the attributes are put in a differently-colored box.  
    
* **SEPARATOR**  
  Inserts empty space and optionally a text line into the vertical layout between two items.  

	* `label`: (optional) A label to show at the separator location  

* **ROLLOUT**

  The rollout is a container which shows its children when open and only shows its label (and optionally a checkbox) when closed.

	* `name`: (stirng) Required. An arbitrary string which serves as an identifier of the rollout and has to be unique per plugin (i.e. the same name may appear in two different plugins but not within the same plugin)

	* `default_closed`: (bool) Optional. Set to *false* to show the rollout initially open. Default is *true.*

	* `use_prop`: (string) The name of a boolean property to use as a checkbox that enables the whole rollout.

   ``` json
	{  
		"layout": "ROLLOUT",  
		"label":  "Options",  
		"name":   "options",  
		"default_closed": false,  
		"use_prop": "enabled",  
		"attrs": []  
	}  
   ``` 


### **Property descriptions** {#property-descriptions}

A property description adds a single plugin property to the widget UI.

`name`:		(string) The name of the property in the plugin’s json description file to bind to (the ID field)  
`label`:		(string) By default, the label of the item is created automatically by Blender from the name of the property by replacing underscores with spaces and capitalizing the first letter of each word ( e.g. "invert\_normals” becomes "Invert Normals” ). The label property allows overriding with a custom value.  
`animatable`:	(bool) Whether the property can be animated. The default value is true. Overrides the 'animatable' property set at plugin level.   
`active`:		(bool/[`condition`](#conditions)) Enabled / disabled state of the item in the UI.  
`visible`:		(bool/[`condition`](#conditions)) Visibility of the item in the UI.  
`slider`:		(bool) Show a slider over a numerical value  
`expand`:	(bool) If the width of the panel is above a certain value (which is hardcoded in our code and can be changed if needed), show ENUM items as buttons instead of a drop-down list.  
NOTE: currently, the original caption is not shown when `expand` is true ( a bug  ) 

### **Conditional expressions** {#conditions}

Conditions are declaratively stated constraints on a property or a widget. The condition consists of two parts: its **target**, which is used to determine the semantics of the constraint, and its **definition**, which determines the way to evaluate the condition. A definition contains one or more rules, each one of which has an associated evaluatable expression composed by the rules described [here](https://git.chaosgroup.com/core/cgrepo/-/blob/master/vray/pluginlib/include/vray_uiguides.h), or a [predicate](#predicates).

* single-rule condition: consists of one expression that returns True or False  
* multi-rule condition: consists of multiple expressions which are evaluated in the order of appearance. Each expression has an associated value which is returned if the expression evaluates to True. The expressions must cover all possible outcomes.


Conditional expressions are introduces with the *cond* attribute: 

`cond`:	(string / dict) The expression to evaluate. 

```json
"active":
{
	// Single-rule, returns True/False
	"cond": "::num_rays<10"
},
"label" : {
	// Multi-rule, returns "Sparse" or "Dense" depending on the first expression that evaluated to True
	"cond" : {
		"Sparse": "::samples<10",
		"Dense":  "::samples>=10"
	}
}

```

From the above rules, the followinf Python code will be generated
```py
# Single-rule
if plugin["num_rays"] < 10:
	return True
else:
	return False 

# Multi-rule
if plugin["samples"] < 10:
   return "Sparse"
elif plugin["samples"] >= 10:
   return "Dense"
   
```

### **Predicates** {#predicates}

Predicate functions are [**custom callbacks**](#callbacks) which evaluate the condition rules instead of expressions. The signature of the predicate is:

```py
def predicate(propGroup: dict, node: bpy.types.Node)
```


### Custom callbacks {#callbacks}
The format for the function name is **[module_path.]function_name**, e.g.

```
{
    ...,
    "update": "nodes.filters.filterGeometries"
}
```
> *module_path* is relative to the *vray_blender* folder (the root of the addon). If it is omitted, the name is looked up in the plugin module corresponding to the plugin description. 